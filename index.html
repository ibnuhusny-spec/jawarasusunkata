<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jawara Susun Kata</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Changa+One&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #27ae60;
            --secondary: #2980b9;
            --accent: #f39c12;
            --wrong: #c0392b;
            --bg-color: #f4f7f6;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: url('https://i.postimg.cc/J09KP28B/Untitled_1.png') no-repeat center center fixed;
            background-size: cover;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; user-select: none; touch-action: none;
        }

        /* --- SCREEN MANAGER --- */
        .screen {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            transition: opacity 0.5s; z-index: 1; padding: 20px; box-sizing: border-box;
        }
        .screen.active { display: flex !important; z-index: 10; animation: fadeIn 0.5s; }

        /* --- STYLES --- */
        .btn-metallic {
            position: relative; padding: 15px 30px; font-family: 'Changa One', sans-serif; font-size: 1.5rem;
            color: white; text-transform: uppercase; text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
            border: 4px solid white; border-radius: 50px; cursor: pointer; outline: none; margin: 10px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.2), inset 0 3px 0 rgba(255,255,255,0.5), inset 0 -3px 0 rgba(0,0,0,0.1);
            transition: all 0.1s; min-width: 200px; text-align: center;
            -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation;
        }
        .btn-metallic:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.2), inset 0 3px 0 rgba(0,0,0,0.1); }
        .btn-green { background: linear-gradient(180deg, #2ecc71 0%, #27ae60 100%); }
        .btn-blue { background: linear-gradient(180deg, #3498db 0%, #2980b9 100%); }
        .btn-orange { background: linear-gradient(180deg, #f1c40f 0%, #f39c12 100%); }
        .btn-red { background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); }

        .menu-title { font-family: 'Changa One', cursive; font-size: 2.5rem; color: var(--secondary); margin-bottom: 20px; text-shadow: 2px 2px 0 white; text-align: center; }
        .input-box { padding: 15px; border-radius: 15px; border: 3px solid #ccc; font-size: 1.2rem; width: 100%; max-width: 300px; text-align: center; font-family: 'Fredoka', sans-serif; outline: none; margin-bottom: 10px; }
        
        /* SPLASH ITEMS */
        .logo-img { 
            width: 100px; margin-bottom: 10px; 
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); 
            display: block; margin: 0 auto 10px;
            animation: breathe 3s infinite ease-in-out;
        }
        
        /* JUDUL UTAMA DARI GAMBAR JAWARA.PNG - DIPERBAIKI AGAR TIDAK KEGEDEAN */
        .main-title-img {
            width: auto; /* Biar rasio tetap */
            max-width: 90%; /* Tidak melebar lebih dari layar */
            max-height: 150px; /* BATAS TINGGI AGAR TIDAK MENUTUPI LAYAR */
            display: block; margin: 10px auto;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
            animation: breathe 4s infinite ease-in-out;
        }

        @keyframes breathe {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .school-info { font-family: sans-serif; color: white; margin-top: 20px; font-weight: bold; font-size: 1.2rem; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; text-align: center; }
        .dev-team { font-size: 0.9rem; color: white; margin-top: 5px; text-shadow: 1px 1px 2px black; text-align: center; }

        @media (max-width: 600px) { 
            .logo-img { width: 80px; }
            .main-title-img { max-height: 120px; } /* Lebih kecil di HP */
        }

        /* GAMEPLAY */
        #game-container { display: flex; width: 100%; height: 100%; padding-top: 80px; box-sizing: border-box; }
        .player-panel { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding: 5px; position: relative; border-right: 2px dashed rgba(255,255,255,0.5); }
        .player-panel:last-child { border-right: none; }
        
        .panel-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Changa One', cursive; font-size: 2rem; color: var(--primary);
            text-align: center; border-radius: 15px;
        }
        
        .game-card { background: white; padding: 5px; border-radius: 15px; border: 2px solid white; box-shadow: 0 5px 10px rgba(0,0,0,0.1); margin-bottom: 5px; width: 95%; max-width: 300px; text-align: center; }
        .image-preview img { width: 100%; height: 80px; object-fit: contain; }
        
        /* HINT STYLE */
        .word-hint {
            font-family: 'Amiri', serif; font-size: 2.5rem; color: #888; background: #fffbf0;
            border: 2px dashed #ffeeba; border-radius: 10px; margin-top: 2px; padding: 0 10px;
            display: none; line-height: 1.2; pointer-events: none;
        }
        
        /* ARTI KATA */
        .word-meaning {
            font-family: 'Fredoka', sans-serif; font-size: 1rem; color: var(--secondary);
            margin-top: 2px; font-weight: bold;
        }
        
        .slots-container { display: flex; gap: 5px; margin: 5px 0; direction: rtl; min-height: 60px; align-items: center; justify-content: center; flex-wrap: wrap; }
        .slot { width: 45px; height: 60px; background: #ecf0f1; border: 2px dashed #bdc3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Amiri', serif; font-size: 30px; transition: all 0.3s; cursor: pointer; margin: 2px; }
        .slot.correct { background: #d4edda; border-color: #28a745; }
        .slot.wrong { background: #f8d7da; border-color: #dc3545; animation: shake 0.4s; }

        /* Layout Adjustment for Pool & Button */
        .letters-pool { 
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; width: 98%; direction: rtl; 
            padding: 5px; background: rgba(255,255,255,0.3); border-radius: 15px; 
            min-height: 80px; margin-bottom: 5px;
        }
        .letter-card { width: 45px; height: 45px; background: white; border: 2px solid #bdc3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-family: 'Amiri', serif; font-size: 26px; cursor: grab; box-shadow: 0 4px 0 #bdc3c7; user-select: none; touch-action: none; }
        .letter-card.touch-dragging { position: fixed; z-index: 9999; opacity: 0.9; transform: scale(1.2); pointer-events: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .letter-card.hidden { opacity: 0; pointer-events: none; }
        .slot .letter-card { border: none; background: transparent; box-shadow: none; font-size: 38px; margin-top: -5px; width: 100%; height: 100%; cursor: pointer; pointer-events: auto; }

        .top-bar { position: absolute; top: 0; left: 0; width: 100%; height: 80px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 50; border-bottom: 4px solid var(--primary); }
        .timer-badge { background: var(--wrong); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.5rem; min-width: 60px; text-align: center; }
        .round-indicator { font-size: 0.9rem; font-weight: bold; color: #666; margin-top: 2px; }
        
        .p-info { text-align: center; width: 100%; margin-bottom: 2px; }
        .p-name { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .p-score { font-size: 0.9rem; color: #555; }
        .p-lives { color: var(--wrong); letter-spacing: 2px; font-size: 1rem;}
        
        .nav-btn, .home-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #eee; background: white; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .home-btn { position: absolute; top: 20px; left: 20px; z-index: 60; }

        .level-scroll-container { width: 100%; max-height: 70vh; overflow-y: auto; padding: 10px; -ms-overflow-style: none; scrollbar-width: none; }
        .level-scroll-container::-webkit-scrollbar { display: none; }
        .level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; width: 100%; max-width: 900px; margin: 0 auto; }
        .level-card { background: white; padding: 15px; border-radius: 15px; text-align: center; cursor: pointer; border: 2px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .level-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .level-title { font-weight: bold; color: var(--secondary); font-size: 1.1rem; }
        .level-sub { font-size: 0.8rem; color: #777; }

        .mode-toggle-container { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .mode-btn { padding: 10px 20px; border-radius: 30px; border: none; font-family: 'Fredoka'; font-weight: bold; cursor: pointer; transition: all 0.3s; background: transparent; color: #555; font-size: 1rem; }
        .mode-btn.active { background: var(--secondary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: scale(1.05); }

        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; width: 100%; padding-bottom: 20px; }
        .vocab-card { background: white; border-radius: 15px; padding: 10px; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .vocab-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 5px; }
        .vocab-arab { font-family: 'Amiri', serif; font-size: 1.8rem; color: var(--primary); margin: 5px 0; }
        .vocab-indo { font-size: 0.9rem; font-weight: bold; color: #555; }
        .vocab-play-btn { background: var(--accent); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; margin-top: 5px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal-box { background: #fdfdfd; padding: 30px; border-radius: 20px; width: 85%; max-width: 450px; text-align: center; border: 5px solid white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: fadeIn 0.3s; }
        
        .lb-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        .lb-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.1rem; }
        .lb-item:first-child { color: var(--accent); font-weight: bold; font-size: 1.3rem; }

        .settings-section { margin: 15px 0; text-align: left; }
        .settings-title { font-weight: bold; color: var(--primary); margin-bottom: 5px; display: block; }
        .radio-group { background: #eee; padding: 10px; border-radius: 10px; }
        .radio-item { display: block; margin: 5px 0; cursor: pointer; }
        
        .instruction-list { text-align: left; margin: 10px 0; font-size: 0.9rem; color: #555; }
        .instruction-list li { margin-bottom: 5px; }

        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 1; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes shake { 0%,100% {transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        
        .audio-check { position:absolute; top:20px; left:20px; font-size:1.5rem; background:rgba(255,255,255,0.3); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; border:2px solid white; }
    </style>
</head>
<body>

    <!-- 1. SPLASH -->
    <div id="splash-screen" class="screen active">
        <div class="audio-check" onclick="testSound(event)">üîä</div>
        <img src="logo.png" alt="Logo Sekolah" class="logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2602/2602414.png'">
        
        <!-- JUDUL DARI GAMBAR -->
        <img src="jawara.png" alt="JAWARA SUSUN KATA" class="main-title-img" onerror="this.style.display='none'; document.getElementById('fallback-title').style.display='block';">
        <div id="fallback-title" class="game-title-splash" style="display:none;">JAWARA<br>SUSUN KATA</div>

        <div class="school-info">SDIT Qurratu A'yun Al-Islami Maros</div>
        <div class="dev-team">Tim Pengembang Sekolah</div>
        <div style="margin-top:40px;">
            <button class="btn-metallic btn-green" onclick="initAudioContext()" style="font-size: 1.5rem; padding: 15px 50px; animation: shake 3s infinite;">KLIK UNTUK MULAI</button>
        </div>
    </div>

    <!-- 2. MODE SELECT -->
    <div id="mode-screen" class="screen">
        <button class="home-btn" onclick="showScreen('splash-screen')">üè†</button>
        <h2 class="menu-title">Pilih Mode Main</h2>
        <button class="btn-metallic btn-blue" onclick="selectMode(1)">üë§ 1 Player</button>
        <button class="btn-metallic btn-orange" onclick="selectMode(2)">üë• 2 Player</button>
        
        <button class="btn-metallic btn-red" onclick="openInstructions()" style="margin-top: 20px; font-size: 1rem; padding: 10px 20px;">‚ùì Petunjuk Permainan</button>
    </div>

    <!-- 3. INPUT NAMA -->
    <div id="entry-screen" class="screen">
        <button class="home-btn" onclick="showScreen('mode-screen')">üè†</button>
        <h2 class="menu-title" id="entryTitle">Masukkan Nama</h2>
        <div id="inputContainer" style="width: 100%; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="btn-metallic btn-green" onclick="submitName()">üöÄ MASUK</button>
        <div class="icon-btn-container" style="display:flex; gap:15px; margin-top:20px; justify-content:center;">
            <button class="nav-btn" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="nav-btn" onclick="openLeaderboard()">üèÜ</button>
        </div>
    </div>

    <!-- 4. LEVEL / THEME SELECT -->
    <div id="level-screen" class="screen">
        <button class="home-btn" onclick="showScreen('mode-screen')">üè†</button>
        <div class="mode-toggle-container" style="margin-top:30px;">
            <button id="btnPlayMode" class="mode-btn active" onclick="setAppMode('play')">üéÆ MODE BERMAIN</button>
            <button id="btnStudyMode" class="mode-btn" onclick="setAppMode('study')">üìñ BANK KOSAKATA</button>
        </div>
        
        <h2 class="menu-title" id="themeTitle" style="margin-bottom:10px; font-size:1.8rem;">Pilih Tema</h2>
        
        <div class="level-scroll-container">
            <div id="levelGrid" class="level-grid"></div>
        </div>
        <button class="btn-metallic btn-red" style="font-size:1rem; padding:10px 20px; margin-top:10px;" onclick="showScreen('entry-screen')">Kembali</button>
    </div>

    <!-- 5. GAME SCREEN -->
    <div id="game-screen" class="screen" style="padding:0;">
        <div class="top-bar">
            <button class="nav-btn" onclick="confirmExit()">üè†</button>
            <div style="display:flex; align-items:center;">
                <div class="timer-badge" id="dispTimer">90</div>
                <div class="round-indicator" id="roundDisp">Soal 1/10</div>
            </div>
            <button class="nav-btn" onclick="showScreen('level-screen')">üîô</button>
        </div>

        <div id="game-container">
            <!-- P1 -->
            <div class="player-panel" id="p1-panel">
                <div class="panel-overlay" id="p1-overlay"><div>‚úÖ SELESAI</div><div style="font-size:1rem; margin-top:10px;">Menunggu Lawan...</div></div>
                <div class="p-info">
                    <div class="p-name" id="p1-name-disp">P1</div>
                    <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                        <span class="p-lives" id="p1-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                        <span class="p-score" id="p1-score-disp">0</span>
                    </div>
                    <div class="round-indicator" id="p1-round-disp">Soal 1/10</div>
                </div>
                <div class="game-card">
                    <div class="image-preview"><img id="p1-img" src=""></div>
                    <div class="word-meaning" id="p1-meaning"></div>
                    <!-- HINT -->
                    <div id="p1-hint" class="word-hint"></div>
                    <button class="btn-metallic btn-blue" style="font-size:0.8rem; padding:5px 15px; min-width:120px; width:auto; margin: 5px auto; display: block;" onclick="playTTS(0)">üîä Dengar Kata</button>
                </div>
                <div class="slots-container" id="p1-slots"></div>
                <div class="letters-pool" id="p1-pool"></div>
                
                <button id="p1-check" class="btn-metallic btn-green" onpointerdown="handleCheck(event, 1)" style="display:none; transform:scale(0.8); margin: 2px;">Cek Jawaban</button>
                <div id="p1-msg" style="margin-top:5px; font-weight:bold; height:20px;"></div>
            </div>

            <!-- P2 -->
            <div class="player-panel" id="p2-panel" style="display:none; border-left: 2px dashed #ccc;">
                <div class="panel-overlay" id="p2-overlay"><div>‚úÖ SELESAI</div><div style="font-size:1rem; margin-top:10px;">Menunggu Lawan...</div></div>
                <div class="p-info">
                    <div class="p-name" id="p2-name-disp">P2</div>
                    <div style="display:flex; justify-content:center; gap:10px; align-items:center;">
                        <span class="p-lives" id="p2-lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                        <span class="p-score" id="p2-score-disp">0</span>
                    </div>
                    <div class="round-indicator" id="p2-round-disp">Soal 1/10</div>
                </div>
                <div class="game-card">
                    <div class="image-preview"><img id="p2-img" src=""></div>
                    <div class="word-meaning" id="p2-meaning"></div>
                    <!-- HINT -->
                    <div id="p2-hint" class="word-hint"></div>
                    <button class="btn-metallic btn-blue" style="font-size:0.8rem; padding:5px 15px; min-width:120px; width:auto; margin: 5px auto; display: block;" onclick="playTTS(1)">üîä Dengar Kata</button>
                </div>
                <div class="slots-container" id="p2-slots"></div>
                <div class="letters-pool" id="p2-pool"></div>
                
                <button id="p2-check" class="btn-metallic btn-green" onpointerdown="handleCheck(event, 2)" style="display:none; transform:scale(0.8); margin: 2px;">Cek Jawaban</button>
                <div id="p2-msg" style="margin-top:5px; font-weight:bold; height:20px;"></div>
            </div>
        </div>
    </div>

    <!-- VOCABULARY SCREEN -->
    <div id="vocab-screen" class="screen">
        <div class="top-bar">
            <button class="nav-btn" onclick="showScreen('mode-screen')">üè†</button>
            <div style="font-family:'Changa One'; font-size:1.5rem; color:var(--secondary);" id="vocabTitle">Bank Kosakata</div>
            <button class="nav-btn" onclick="showScreen('level-screen')">üîô</button>
        </div>
        <div class="level-scroll-container" style="margin-top:80px;">
            <div id="vocabGrid" class="vocab-grid"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="result-overlay" class="modal-overlay">
        <div class="modal-box" style="border-color: var(--accent);">
            <h2 id="resultTitle" class="menu-title" style="margin-bottom:0;">SELESAI!</h2>
            <div id="resultContent" style="font-size:1.2rem; color:#333; margin:20px 0;"></div>
            <button class="btn-metallic btn-blue" onclick="backToLevels()">Lanjut</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 class="menu-title">Pengaturan</h2>
            <div class="settings-section">
                <span class="settings-title">Waktu Permainan:</span>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="time" value="90" checked> 90 Detik (Lambat - Ada Bantuan)</label>
                    <label class="radio-item"><input type="radio" name="time" value="60"> 60 Detik (Normal - Tanpa Bantuan)</label>
                    <label class="radio-item"><input type="radio" name="time" value="30"> 30 Detik (Cepat - Tanpa Bantuan)</label>
                </div>
            </div>
            <div class="settings-section">
                <span class="settings-title">Suara & Musik:</span>
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="sound" value="on" checked> Hidup (On)</label>
                    <label class="radio-item"><input type="radio" name="sound" value="off"> Mati (Off)</label>
                </div>
            </div>
            <button class="btn-metallic btn-blue" onclick="closeSettings()">Simpan</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-box">
            <h2>üèÜ Top 3 Skor</h2>
            <div id="lb-container" style="min-height:100px; display:flex; align-items:center; justify-content:center;">
                <ul id="lb-list" class="lb-list" style="width:100%;"></ul>
                <div id="lb-empty-msg" style="color:#888;">Belum ada skor.<br>Jadilah yang pertama!</div>
            </div>
            <button class="btn-metallic btn-red" onclick="closeLeaderboard()">Tutup</button>
        </div>
    </div>

    <div id="instruction-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: left;">
            <h2 class="menu-title" style="margin-bottom: 10px;">Petunjuk Permainan</h2>
            <ul class="instruction-list">
                <li>1. Pilih Mode 1 Player atau 2 Player.</li>
                <li>2. Pilih Tema/Sesi yang ingin dimainkan.</li>
                <li>3. Susun huruf-huruf Arab menjadi kata yang sesuai dengan gambar.</li>
                <li>4. <b>Geser (Drag)</b> huruf ke kotak kosong yang tersedia.</li>
                <li>5. Jika salah, ketuk huruf di dalam kotak untuk menghapusnya.</li>
                <li>6. Selesaikan 10 soal sebelum waktu habis!</li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-metallic btn-blue" onclick="closeInstructions()">Saya Mengerti</button>
            </div>
        </div>
    </div>
    
    <div id="toast">Notifikasi</div>

    <script>
        // --- KONFIGURASI GOOGLE SHEET ---
        const GOOGLE_SCRIPT_URL = ""; 

        // --- ROBUST AUDIO ENGINE ---
        let audioCtx;
        function initAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playTone(0, 0.1); 
            showScreen('mode-screen');
        }

        function playTone(freq, type = 'sine') {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        const sounds = {
            pop: new Audio("https://actions.google.com/sounds/v1/cartoon/pop_egg.ogg"),
            win: new Audio("https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg"),
            lose: new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg")
        };

        // --- FIX AUDIO BERSUSUN: SINGLE TONE FOR TYPING ---
        let canPlayTypeSound = true;
        
        function playSound(type) {
            if (appState.sound === 'off') return;
            
            // CLEAN TYPING SOUND
            if (type === 'pop') {
                 if (canPlayTypeSound) {
                    playTone(600, 'triangle');
                    canPlayTypeSound = false;
                    setTimeout(() => { canPlayTypeSound = true; }, 50); // Debounce 50ms
                 }
                 return;
            }

            const sound = sounds[type];
            if (sound) {
                const clone = sound.cloneNode();
                clone.play().catch(e => {
                    if(type === 'win') { playTone(500, 'sine'); setTimeout(()=>playTone(800, 'sine'), 100); setTimeout(()=>playTone(1000, 'sine'), 200); }
                    if(type === 'lose') { playTone(300, 'sawtooth'); setTimeout(()=>playTone(200, 'sawtooth'), 200); }
                });
            }
        }
        
        function testSound(e) {
            e.stopPropagation();
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioCtx.resume().then(() => { playSound('win'); showToast("üîä Tes Suara"); });
        }

        // --- DATA INPUT ---
        const rawVocabData = [
             { theme: "Perlengkapan Sekolah", items: [["ŸÇŸéŸÑŸéŸÜŸíÿ≥ŸèŸàŸéÿ©Ÿå", "Peci"], ["ÿ≠Ÿêÿ¨Ÿéÿßÿ®Ÿå", "Jilbab"], ["ŸÇŸéŸÖŸêŸäÿµŸå", "Kemeja"], ["ÿ≠ŸéŸÇŸêŸäÿ®Ÿéÿ©Ÿå", "Tas"], ["ÿ≠Ÿêÿ∞Ÿéÿßÿ°Ÿå", "Sepatu"], ["ÿ¨ŸéŸàŸíÿ±Ÿéÿ®Ÿå", "Kaos kaki"], ["ÿ®ŸéŸÜŸíÿ∑ŸéŸÑŸèŸàŸÜŸå", "Celana panjang"], ["ÿ™ŸéŸÜŸèŸëŸàÿ±Ÿéÿ©Ÿå", "Rok"], ["ÿ≥ŸéÿßÿπŸéÿ©Ÿå", "Jam"], ["ŸÇŸèÿ®ŸéŸëÿπŸéÿ©Ÿå", "Topi"]] },
            { theme: "Perlengkapan Pribadi 1", items: [["ÿ≥Ÿêÿ±ŸíŸàŸéÿßŸÑŸå", "Celana pendek"], ["ÿ•Ÿêÿ≤Ÿéÿßÿ±Ÿå", "Sarung"], ["ŸÖŸèÿ¥ŸéŸÖŸéŸëÿπŸå", "Jas hujan"], ["ŸÖŸêÿ∏ŸéŸÑŸéŸëÿ©Ÿå", "Payung"], ["ÿπŸèŸÑŸíÿ®Ÿéÿ©Ÿå", "Kotak makan"], ["ÿ≤Ÿèÿ¨Ÿéÿßÿ¨Ÿéÿ©Ÿå", "Botol minum"], ["ÿ≠Ÿêÿ≤ŸéÿßŸÖŸå", "Ikat pinggang"], ["ŸÖŸêŸÜŸíÿØŸêŸäŸÑŸå", "Saputangan"], ["ŸÇŸèŸÅŸëŸéÿßÿ≤Ÿå", "Kaos Tangan"], ["ŸÜŸéÿπŸíŸÑŸå", "Sandal"]] },
            { theme: "Perlengkapan Pribadi 2", items: [["ÿÆŸèŸàÿ≤Ÿéÿ©Ÿå", "Helm"], ["ŸÜŸéÿ∏ŸëŸéÿßÿ±Ÿéÿ©Ÿå", "Kacamata"], ["ŸÇŸêŸÑŸéÿßÿØŸéÿ©Ÿå", "Kalung"], ["ÿ≥ŸêŸàŸéÿßÿ±Ÿå", "Gelang"], ["ŸÇŸêÿ±Ÿí ÿ∑Ÿå", "Anting-anting"], ["ÿπŸêÿ∑Ÿíÿ±Ÿå", "Minyak Wangi"], ["ŸÖŸêÿ≠ŸíŸÅŸéÿ∏Ÿéÿ©Ÿå", "Dompet"], ["ŸÜŸèŸÇŸèŸà ÿØŸå", "Uang"], ["ŸÖŸêŸÜŸíÿ¥ŸéŸÅŸéÿ©Ÿå", "Handuk"], ["ŸÖŸêŸÅŸíÿ™Ÿéÿßÿ≠Ÿå", "Kunci"]] },
            { theme: "Alat Tulis Menulis", items: [["ŸÉŸêÿ™Ÿéÿßÿ®Ÿå", "Buku cetak"], ["ÿØŸéŸÅŸíÿ™Ÿéÿ±Ÿå", "Buku tulis"], ["ÿ®Ÿéÿ±ŸéŸëÿßŸäŸéÿ©Ÿå", "Peraut"], ["ŸÖŸêÿ≥Ÿíÿ∑Ÿéÿ±Ÿéÿ©Ÿå", "Penggaris"], ["ŸÇŸéŸÑŸéŸÖŸå", "Pulpen"], ["ŸÖŸêÿ±Ÿíÿ≥ŸéŸÖŸå", "Pensil"], ["ŸÖŸèÿ≤ŸêŸäŸÑŸå", "Tipe-X"], ["ŸÖŸêŸÖŸíÿ≠Ÿéÿßÿ©Ÿå", "Penghapus"], ["ÿ≠Ÿêÿ®Ÿíÿ±Ÿå", "Tinta"], ["ŸÖŸêŸÇŸíŸÑŸéŸÖŸéÿ©Ÿå", "Tempat Pulpen"]] },
            { theme: "Kantor & Sekolah", items: [["ÿ¥ŸéŸáŸéÿßÿØŸéÿ©Ÿå", "Ijazah"], ["ÿÆŸéÿ±ŸêŸäÿ∑Ÿéÿ©Ÿå", "Peta"], ["ÿ≥Ÿéÿ®ŸèŸëŸàÿ±Ÿéÿ©Ÿå", "Papan tulis"], ["ŸÇŸêÿ±Ÿíÿ∑Ÿéÿßÿ≥Ÿå", "Kertas"], ["ŸÉŸéÿ¥ŸíŸÅŸè ÿ≠Ÿèÿ∂ŸèŸàÿ±Ÿç", "Daftar hadir"], ["ÿ∫Ÿêÿ±Ÿéÿßÿ°Ÿå", "Lem"], ["ÿ∫ŸêŸÑŸéÿßŸÅŸå", "Amplop"], ["ÿ™ŸéŸÇŸíŸàŸêŸäŸÖŸå", "Kalender"], ["ÿ±Ÿêÿ≥ŸéÿßŸÑŸéÿ©Ÿå", "Surat"], ["ŸÖŸéŸÑŸéŸÅŸå", "Map"]] },
            { theme: "Tempat di Sekolah", items: [["ŸÖŸéÿØŸíÿ±Ÿéÿ≥Ÿéÿ©Ÿå", "Sekolah"], ["ŸÅŸéÿµŸíŸÑŸå", "Kelas"], ["ŸÖŸéŸÉŸíÿ™Ÿéÿ®Ÿéÿ©Ÿå", "Perpustakaan"], ["ŸÖŸéÿπŸíŸÖŸéŸÑŸå", "Laboratorium"], ["ŸÖŸèÿµŸéŸÑŸéŸëŸâ", "Musala"], ["ÿ≥Ÿéÿßÿ≠Ÿéÿ©Ÿå", "Pekarangan"], ["ŸÖŸéŸÇŸíÿµŸéŸÅŸå", "Kantin"], ["ŸÖŸéŸàŸíŸÇŸêŸÅŸå", "Parkiran"], ["ÿ≠ŸéŸÖŸéŸëÿßŸÖŸå", "Kamar mandi"], ["ŸÖŸêÿ±Ÿíÿ≠Ÿéÿßÿ∂Ÿå", "WC"]] },
            { theme: "Rumah", items: [["ÿ®ŸéŸäŸíÿ™Ÿå", "Rumah"], ["ÿ®Ÿéÿßÿ®Ÿå", "Pintu"], ["ŸÜŸéÿßŸÅŸêÿ∞Ÿéÿ©Ÿå", "Jendela"], ["ÿ≥ŸéŸÇŸíŸÅŸå", "Atap"], ["ÿ®ŸêŸÑŸéÿßÿ∑Ÿå", "Lantai"], ["ÿ≥ŸèŸàÿ±Ÿå", "Pagar"], ["ÿ¨ŸêÿØŸéÿßÿ±Ÿå", "Dinding"], ["ÿ≥ŸèŸÑŸéŸëŸÖŸå", "Tangga"], ["ŸÖŸéÿ∑Ÿíÿ®ŸéÿÆŸå", "Dapur"], ["ÿ∫Ÿèÿ±ŸíŸÅŸéÿ©Ÿå", "Kamar"]] },
            { theme: "Perlengkapan Rumah 1", items: [["ŸÖŸéŸÉŸíÿ™Ÿéÿ®Ÿå", "Meja"], ["ŸÉŸèÿ±Ÿíÿ≥ŸêŸäŸåŸë", "Kursi"], ["ÿÆŸêÿ≤ŸéÿßŸÜŸéÿ©Ÿå", "Lemari"], ["ÿ±ŸéŸÅŸåŸë", "Rak"], ["ÿ≥Ÿéÿ±ŸêŸäÿ±Ÿå", "Ranjang"], ["ŸàŸêÿ≥ŸéÿßÿØŸéÿ©Ÿå", "Bantal"], ["ŸÖŸêŸÉŸíŸÜŸéÿ≥Ÿéÿ©Ÿå", "Sapu"], ["ŸÖŸéÿ≤Ÿíÿ®ŸéŸÑŸéÿ©Ÿå", "Tempat sampah"], ["ŸÖŸêÿ±Ÿíÿ¢ÿ©Ÿå", "Cermin"], ["ŸÖŸèÿ¥Ÿíÿ∑Ÿå", "Sisir"]] },
            { theme: "Perlengkapan Rumah 2", items: [["ŸÅŸêÿ±Ÿé ÿßÿ¥Ÿå", "Kasur"], ["ŸÜŸéÿßŸÖŸèŸàÿ≥ŸêŸäŸëŸéÿ©Ÿå", "Kelambu"], ["ŸÑŸêÿ≠ŸéÿßŸÅŸå", "Selimut"], ["ÿ¥Ÿêÿ±Ÿíÿ¥ŸéÿßŸÅŸå", "Seprei"], ["ÿ≥Ÿéÿ¨ŸëŸéÿßÿØŸéÿ©Ÿå", "Permadani"], ["ÿ≠ŸéÿµŸêŸäÿ±Ÿå", "Tikar"], ["ŸÖŸêÿÆŸéÿØŸëŸéÿ©Ÿå", "Guling"], ["ÿ≥Ÿêÿ™Ÿéÿßÿ±Ÿé ÿ©Ÿå", "Gorden"], ["ŸÖŸêÿ¥Ÿíÿ¨Ÿéÿ®Ÿå", "Gantungan"], ["ŸÖŸèŸÜŸéÿ®ŸëŸêŸáŸéÿ©Ÿå", "Jam Weker"]] },
            { theme: "Alat Elektronik", items: [["ŸÉŸèŸàŸÖŸíÿ®ŸêŸäŸèŸàÿ™ŸéŸÄÿ±Ÿå", "Komputer"], ["ÿ¨ŸéŸàŸëŸéÿßŸÑŸå", "Handphone"], ["ŸÖŸèŸÉŸéŸäŸëŸêŸÅŸå", "AC"], ["ÿ´ŸéŸÑŸëŸéÿßÿ¨Ÿéÿ©Ÿå", "Kulkas"], ["ŸÖŸêÿ∞ŸíŸäŸéÿßÿπŸå", "Radio"], ["ÿ∫Ÿéÿ≥ŸëŸéÿßŸÑŸéÿ©Ÿå", "Mesin Cuci"], ["ŸÅŸèÿ±Ÿí ŸÜŸå", "Oven"], ["ŸÖŸêŸÉŸíŸàŸéÿßÿ©Ÿå", "Seterika"], ["ÿ™ŸêŸÑŸíŸÅŸéÿßÿ≤Ÿå", "Televisi"], ["ŸÖŸêÿ±Ÿí ŸàŸéÿ≠Ÿéÿ©Ÿå", "Kipas Angin"]] },
            { theme: "Tempat & Lokasi 1", items: [["ÿØŸèŸÉŸéŸëÿßŸÜŸå", "Toko"], ["ŸÖŸéÿ≥Ÿíÿ¨ŸêÿØŸå", "Masjid"], ["ŸÖŸèÿ≥Ÿíÿ™Ÿéÿ¥ŸíŸÅŸãŸâ", "Rumah sakit"], ["ÿµŸéŸäŸíÿØŸéŸÑŸêŸäŸéŸëÿ©Ÿå", "Apotek"], ["ŸÖŸéÿ∑Ÿéÿßÿ±Ÿå", "Bandara"], ["ŸÖŸêŸäŸÜŸéÿßÿ°Ÿå", "Pelabuhan"], ["ÿ¨ŸéÿßŸÖŸêÿπŸéÿ©Ÿå", "Universitas"], ["ŸÖŸèÿ™Ÿíÿ≠ŸéŸÅŸå", "Museum"], ["ŸÖŸéÿ∑ŸíÿπŸéŸÖŸå", "Restoran"], ["ŸÅŸèŸÜŸíÿØŸèŸÇŸå", "Hotel"]] },
            { theme: "Tempat & Lokasi 2", items: [["ŸÇŸéÿßÿπŸéÿ©Ÿå", "Aula"], ["ŸÇŸéÿµŸíÿ±Ÿå", "Istana"], ["ŸÖŸéÿµŸíŸÜŸéÿπŸå", "Pabrik"], ["ŸÖŸèÿ≥Ÿíÿ™ŸéŸàŸíÿØŸéÿπŸå", "Gudang"], ["ÿ≥ŸèŸàŸÇŸå", "Pasar"], ["ŸÖŸéŸÉŸíÿ™Ÿéÿ®Ÿè ÿ®Ÿéÿ±Ÿê ŸäÿØŸç", "Kantor Pos"], ["ÿ¥Ÿéÿßÿ±Ÿê ÿπŸå", "Jalan Raya"], ["ÿ¨Ÿêÿ≥Ÿíÿ±Ÿå", "Jembatan"], ["ÿ®Ÿèÿ≥Ÿíÿ™ŸéÿßŸÜŸå", "Taman"], ["ŸÖŸéÿ≤Ÿí ÿ±ŸéÿπŸéÿ©Ÿå", "Sawah"]] },
            { theme: "Negara", items: [["ÿ£ŸéŸÖŸíÿ±Ÿê ŸäŸÉŸéŸÄÿß", "Amerika"], ["ÿ®ŸéÿßŸÉŸêÿ≥Ÿíÿ™ŸéÿßŸÜŸè", "Pakistan"], ["ÿ£ŸéŸÅŸíÿ∫ŸéÿßŸÜŸêÿ≥Ÿíÿ™ŸéÿßŸÜŸè", "Afganistan"], ["ŸÖŸêÿµŸíÿ±Ÿè", "Mesir"], ["ÿ®ŸéŸÄÿ±Ÿé ÿß ÿ≤ŸêŸäŸÑŸè", "Brazil"], ["ÿßŸÑÿµŸëŸêŸäŸÜŸè", "Cina"], ["ÿπŸêÿ±Ÿé ÿßŸÇ", "Irak"], ["ÿ™ŸèŸÄÿ±Ÿí ŸÉŸêŸäŸéÿß", "Turki"], ["ŸÖŸéÿßŸÑŸêŸäÿ≤ŸêŸäŸéÿß", "Malaysia"], ["ŸäŸéŸÄÿßÿ®ŸéŸÄÿßŸÜŸè", "Jepang"]] },
            { theme: "Profesi (Laki-laki)", items: [["ŸÖŸèÿØŸêŸäÿ±Ÿå", "Kepala sekolah"], ["ÿ£Ÿèÿ≥Ÿíÿ™Ÿéÿßÿ∞Ÿå", "Ustaz"], ["ŸÖŸèÿØŸéÿ±ŸêŸëÿ≥Ÿå", "Guru"], ["ÿ∑Ÿéÿ®ŸêŸäÿ®Ÿå", "Dokter"], ["ŸÅŸéŸÑŸéŸëÿßÿ≠Ÿå", "Petani"], ["ÿ™Ÿéÿßÿ¨Ÿêÿ±Ÿå", "Pedagang"], ["ÿ∑ŸéÿßŸÑŸêÿ®Ÿå", "Pelajar"], ["ÿ¥Ÿèÿ±Ÿíÿ∑ŸêŸäŸåŸë", "Polisi"], ["ŸÖŸèÿØŸéÿ±ŸêŸëÿ®Ÿå", "Pelatih"], ["ŸÖŸéŸàŸéÿ∏ŸéŸëŸÅŸå", "Pegawai"]] },
            { theme: "Profesi (Perempuan)", items: [["ŸÖŸèÿØŸêŸäÿ±Ÿéÿ©Ÿå", "Kepala sekolah-pr"], ["ÿ£Ÿéÿ≥Ÿíÿ™Ÿéÿßÿ∞Ÿéÿ©Ÿå", "Ustazah"], ["ŸÖŸèÿØŸéÿ±ŸêŸëÿ≥Ÿéÿ©Ÿå", "Guru-pr"], ["ÿ∑Ÿéÿ®ŸêŸäÿ®Ÿéÿ©Ÿå", "Dokter-pr"], ["ŸÅŸéŸÑŸéŸëÿßÿ≠Ÿéÿ©Ÿå", "Petani-pr"], ["ÿ™Ÿéÿßÿ¨Ÿêÿ±Ÿéÿ©Ÿå", "Pedagang-pr"], ["ÿ∑ŸéÿßŸÑŸêÿ®Ÿéÿ©Ÿå", "Pelajar-pr"], ["ÿ¥Ÿèÿ±Ÿíÿ∑ŸêŸäŸéŸëÿ©Ÿå", "Polwan"], ["ŸÖŸèÿØŸéÿ±ŸêŸëÿ®Ÿéÿ©Ÿå", "Pelatih-pr"], ["ŸÖŸèŸàŸéÿ∏ŸéŸëŸÅŸéÿ©Ÿå", "Pegawai-pr"]] },
            { theme: "Keluarga", items: [["ÿ£Ÿéÿ®Ÿå", "Bapak"], ["ÿ£ŸèŸÖŸåŸë", "Ibu"], ["ŸàŸéŸÑŸéÿØŸå", "Anak laki-laki"], ["ÿ®ŸêŸÜŸíÿ™Ÿå", "Anak Perempuan"], ["ÿ¨ŸéÿØŸåŸë", "Kakek"], ["ÿ¨ŸéÿØŸéŸëÿ©Ÿå", "Nenek"], ["ÿ±Ÿéÿ¨ŸèŸÑŸå", "Laki-laki"], ["ŸÖŸéÿ±Ÿíÿ£Ÿéÿ©Ÿå", "Perempuan"], ["ŸÅŸéÿ™ŸãŸâ", "Pemuda"], ["ŸÅŸéÿ™Ÿéÿßÿ©Ÿå", "Pemudi"]] },
            { theme: "Makanan & Minuman", items: [["ŸÇŸéŸáŸíŸàŸéÿ©Ÿå", "Kopi"], ["ÿ¥ŸéÿßŸäŸå", "Teh"], ["ŸÑŸéÿ®ŸéŸÜŸå", "Susu"], ["ŸÖŸéÿßÿ°Ÿå", "Air"], ["ŸÑŸéÿ≠ŸíŸÖŸå", "Daging"], ["ÿ®ŸéŸäŸíÿ∂Ÿéÿ©Ÿå", "Telur"], ["ÿÆŸèÿ®Ÿíÿ≤Ÿå", "Roti"], ["ÿ¨Ÿèÿ®ŸíŸÜŸå", "Keju"], ["ÿ±Ÿèÿ≤ŸåŸë", "Nasi"], ["ÿ∞Ÿèÿ±Ÿéÿ©Ÿå", "Jagung"]] },
            { theme: "Buah", items: [["ÿ™ŸéŸÖŸíÿ±Ÿå", "Kurma"], ["ŸÖŸéŸàŸíÿ≤Ÿå", "Pisang"], ["ÿ®Ÿéÿßÿ®ŸéÿßŸäŸéÿß", "Pepaya"], ["ÿ™ŸèŸÅŸéŸëÿßÿ≠Ÿå", "Apel"], ["ÿ®Ÿèÿ±Ÿíÿ™ŸèŸÇŸéÿßŸÑŸå", "Jeruk"], ["ÿ®Ÿêÿ∑ŸêŸëŸäÿÆŸå", "Semangka"], ["ÿπŸêŸÜŸéÿ®Ÿå", "Anggur"], ["ŸÑŸéŸäŸíŸÖŸèŸàŸÜŸå", "Lemon"], ["ÿ¨ŸéŸàŸéŸëÿßŸÅŸéÿ©Ÿå", "Jambu"], ["ÿ±ŸèŸÖŸéŸëÿßŸÜŸå", "Delima"]] },
            { theme: "Alat Dapur", items: [["ÿµŸéÿ≠ŸíŸÜŸå", "Piring"], ["ŸÉŸèŸàÿ®Ÿå", "Gelas"], ["ŸÖŸêŸÑŸíÿπŸéŸÇŸéÿ©Ÿå", "Sendok"], ["ÿ¥ŸéŸàŸíŸÉŸéÿ©Ÿå", "Garpu"], ["ÿ≥ŸêŸÉŸêŸëŸäŸÜŸå", "Pisau"], ["ŸÅŸêŸÜŸíÿ¨ŸéÿßŸÜŸå", "Cangkir"], ["ŸÇŸêÿØŸíÿ±Ÿå", "Panci"], ["ŸÖŸêŸÇŸíŸÑŸéÿßÿ©Ÿå", "Wajan"], ["ŸÖŸêÿÆŸíÿ®ŸéÿµŸéÿ©Ÿå", "Sudip"], ["ŸÖŸêŸàŸíŸÇŸêÿØŸå", "Kompor"]] },
            { theme: "Hewan", items: [["ÿ£Ÿéÿ≥ŸéÿØŸå", "Singa"], ["ŸÅŸêŸäŸÑŸå", "Gajah"], ["ŸÜŸéŸÖŸíŸÑŸå", "Semut"], ["ÿØŸêŸäŸÉŸå", "Ayam jantan"], ["ÿ≠ŸêÿµŸéÿßŸÜŸå", "Kuda"], ["ÿ≠ŸêŸÖŸéÿßÿ±Ÿå", "Keledai"], ["ÿ¨ŸéŸÖŸéŸÑŸå", "Unta"], ["ŸÇŸêÿ∑ŸåŸë", "Kucing"], ["ŸÉŸéŸÑŸíÿ®Ÿå", "Anjing"], ["ÿ≥ŸéŸÖŸéŸÉŸå", "Ikan"]] },
            { theme: "Kata Sifat 1", items: [["ÿ¨ŸéŸÖŸêŸäŸÑŸå", "Bagus"], ["ŸÇŸéÿ®ŸêŸäÿ≠Ÿå", "Buruk"], ["ŸàŸéÿßÿ≥ŸêÿπŸå", "Luas"], ["ÿ∂ŸéŸäŸêŸëŸÇŸå", "Sempit"], ["ŸÜŸéÿ∏ŸêŸäŸÅŸå", "Bersih"], ["ŸàŸéÿ≥ŸêÿÆŸå", "Kotor"], ["ÿ¨ŸéÿØŸêŸäÿØŸå", "Baru"], ["ŸÇŸéÿØŸêŸäŸÖŸå", "Tua"], ["ÿ®ŸéÿπŸêŸäÿØŸå", "Jauh"], ["ŸÇŸéÿ±ŸêŸäÿ®Ÿå", "Dekat"]] },
            { theme: "Kata Sifat 2", items: [["ÿ∫ŸéŸÜŸêŸäŸåŸë", "Kaya"], ["ŸÅŸéŸÇŸêŸäÿ±Ÿå", "Miskin"], ["ŸÇŸéŸàŸêŸäŸåŸë", "Kuat"], ["ÿ∂ŸéÿπŸêŸäŸÅŸå", "Lemah"], ["ÿ≥ŸéŸÖŸêŸäŸÜŸå", "Gemuk"], ["ŸÜŸéÿ≠ŸêŸäŸÅŸå", "Kurus"], ["ŸÖŸèÿ¨Ÿíÿ™ŸéŸáŸêÿØŸå", "Rajin"], ["ŸÉŸéÿ≥ŸíŸÑŸéÿßŸÜŸè", "Malas"], ["ŸÖŸêÿ≥Ÿíÿ±ŸèŸàÿ±Ÿå", "Senang"], ["ÿ≠Ÿéÿ≤ŸêŸäŸÜŸå", "Sedih"]] },
            { theme: "Kata Sifat 3", items: [["ŸÖŸèÿ®Ÿíÿ™ŸéŸÑŸåŸë", "Basah"], ["ÿ¨ŸéÿßŸÅŸåŸë", "Kering"], ["ŸÖŸéŸÅŸíÿ™ŸéŸàÿ≠Ÿå", "Terbuka"], ["ŸÖŸèÿ∫ŸíŸÑŸéŸÇŸå", "Tertutup"], ["ÿ´ŸéŸÇŸêŸäŸÑŸå", "Berat"], ["ÿÆŸéŸÅŸêŸäŸÅŸå", "Ringan"], ["ÿ≥ŸéŸáŸíŸÑŸå", "Mudah"], ["ÿµŸéÿπŸêÿ®Ÿå", "Sulit"], ["ÿ≠ŸèŸÑŸíŸàŸå", "Manis"], ["ŸÖŸèÿ±ŸåŸë", "Pahit"]] },
            { theme: "Kata Sifat 4", items: [["ŸÉŸéÿ±ŸêŸäŸÖŸå", "Dermawan"], ["ÿ®ŸéÿÆŸêÿ®ŸÑŸå", "Pelit"], ["ÿ¥Ÿèÿ¨ŸéÿßÿπŸå", "Pemberani"], ["ÿÆŸéÿßÿ¶ŸêŸÅŸå", "Penakut"], ["ŸÖŸèÿ™ŸéŸàŸéÿßÿ∂ŸêÿπŸå", "Rendah hati"], ["ŸÖŸèÿ™ŸéŸÉŸéÿ®ŸêŸëÿ±Ÿå", "Sombong"], ["ÿµŸéÿ≠ŸêŸäÿ≠Ÿå", "Sehat"], ["ŸÖŸéÿ±ŸêŸäÿ∂Ÿå", "Sakit"], ["ÿ£ŸéŸÖŸêŸäŸÜŸå", "Jujur"], ["ŸÉŸéÿßÿ∞Ÿêÿ®Ÿå", "Bohong"]] },
            { theme: "Warna", items: [["ÿ£Ÿéÿ≥ŸíŸàŸéÿØŸè", "Hitam"], ["ÿ£Ÿéÿ®ŸíŸäŸéÿ∂Ÿè", "Putih"], ["ÿ£Ÿéÿ≠ŸíŸÖŸéÿ±Ÿè", "Merah"], ["ÿ£ŸéÿµŸíŸÅŸéÿ±Ÿè", "Kuning"], ["ÿ£ŸéÿÆŸíÿ∂Ÿéÿ±Ÿè", "Hijau"], ["ÿ£Ÿéÿ≤Ÿíÿ±ŸéŸÇŸè", "Biru"], ["ÿ£Ÿéÿ≥ŸíŸÖŸéÿ±Ÿè", "Coklat"], ["ÿ£Ÿéÿ±ŸíŸÖŸéÿØŸè", "Abu-abu"], ["ŸÇŸéÿ±ŸéŸÜŸíŸÅŸèŸÑŸêŸäŸåŸë", "Pink"], ["ÿ®ŸéŸÜŸéŸÅŸíÿ≥Ÿéÿ¨ŸêŸäŸåŸë", "Ungu"]] }
        ];

        const vocabData = rawVocabData.map(theme => {
            return {
                theme: theme.theme,
                items: theme.items.map(item => {
                    const arab = item[0];
                    const indo = item[1];
                    let img;
                    if (item.length > 2) img = item[2];
                    else if (theme.theme.toLowerCase().includes("sifat")) img = "https://cdn-icons-png.flaticon.com/512/210/210545.png"; 
                    else img = `img/${indo.toLowerCase().replace(/\s+/g, '').replace(/[\(\)]/g, '')}.png`;
                    return [arab, indo, img];
                })
            };
        });

        // --- GLOBAL VARIABLES ---
        let appState = { mode: 1, timeLimit: 90, sound: "on", appMode: "play", currentThemeIdx: 0, currentWordIdx: 0, timer: 0, interval: null, questionQueue: [], players: [ { name: "", score: 0, lives: 3, mistakes: 0, finished: false, currentWord: null }, { name: "", score: 0, lives: 3, mistakes: 0, finished: false, currentWord: null } ] };
        let activeDrags = {};
        let localHighScores = [];
        const placeholderImg = "https://cdn-icons-png.flaticon.com/512/3330/3330314.png"; 

        const arabicLetters = /[\u0621-\u064A]/;
        const harakat = /[\u064B-\u065F\u0670\u0651\u0652]/;
        
        function parseArabicWord(word) {
            let parts = []; let current = "";
            for (let i = 0; i < word.length; i++) {
                let char = word[i];
                if (arabicLetters.test(char)) { if (current) parts.push(current); current = char; } 
                else if (harakat.test(char)) { current += char; } 
                else { current += char; }
            }
            if (current) parts.push(current);
            return parts;
        }

        // --- INIT & NAVIGATION ---
        window.onload = function() {
            renderThemeButtons();
            loadScores(); 

            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-metallic, .level-card, .nav-btn, .icon-btn, .mode-btn, .home-btn')) playSound('pop');
            });
            
            document.addEventListener('input', function(e) {
                if (e.target.tagName === 'INPUT' && e.target.type === 'text') playSound('pop');
            });
            
            document.getElementById('p1-check').addEventListener('pointerdown', function(e) { handleCheck(e, 1); });
            document.getElementById('p2-check').addEventListener('pointerdown', function(e) { handleCheck(e, 2); });
        };

        function setAppMode(mode) {
            appState.appMode = mode;
            document.getElementById('btnPlayMode').className = mode === 'play' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnStudyMode').className = mode === 'study' ? 'mode-btn active' : 'mode-btn';
        }

        function renderThemeButtons() {
            const grid = document.getElementById('levelGrid'); grid.innerHTML = "";
            vocabData.forEach((theme, idx) => {
                const btn = document.createElement('div'); btn.className = "level-card"; 
                btn.onclick = () => handleThemeClick(idx);
                const icon = ["üìö","üëï","‚úèÔ∏è","üè´","üè°","üõãÔ∏è","üè•","üë∑","üßï","üë®‚Äçüë©‚Äçüëß","üçé","‚òï","ü•Ñ","ü¶Å","üé®"][idx % 15] || "üåü";
                btn.innerHTML = `<div style="font-size:2.5rem">${icon}</div><div class="level-title">Sesi ${idx+1}</div><div class="level-sub">${theme.theme}</div>`;
                grid.appendChild(btn);
            });
        }

        function handleThemeClick(idx) {
            if(appState.appMode === 'play') {
                startGame(idx);
            } else {
                openVocabBank(idx);
            }
        }

        function openVocabBank(idx) {
            const data = vocabData[idx];
            const grid = document.getElementById('vocabGrid');
            grid.innerHTML = "";
            document.getElementById('vocabTitle').innerText = data.theme;
            
            data.items.forEach(item => {
                const card = document.createElement('div');
                card.className = "vocab-card";
                const imgUrl = item[2] || placeholderImg;
                card.innerHTML = `
                    <img src="${imgUrl}" onerror="this.src='${placeholderImg}'">
                    <div class="vocab-arab">${item[0]}</div>
                    <div class="vocab-indo">${item[1]}</div>
                    <button class="vocab-play-btn" onclick="speakText('${item[0]}')">üîä</button>
                `;
                grid.appendChild(card);
            });
            showScreen('vocab-screen');
        }

        function speakText(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang='ar-SA'; u.rate=0.8; window.speechSynthesis.speak(u);
        }

        function showScreen(id) { stopTimer(); document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function selectMode(m) {
            appState.mode = m;
            const container = document.getElementById('inputContainer'); container.innerHTML = '';
            container.innerHTML += `<input type="text" id="name1" class="input-box" placeholder="Nama Pemain 1" oninput="playSound('pop')">`;
            if(m === 2) {
                container.innerHTML += `<input type="text" id="name2" class="input-box" placeholder="Nama Pemain 2" oninput="playSound('pop')">`;
                document.getElementById('entryTitle').innerText = "Masukkan Nama Pemain";
            } else { document.getElementById('entryTitle').innerText = "Siapa Namamu?"; }
            showScreen('entry-screen');
        }
        function submitName() {
            const n1 = document.getElementById('name1').value.trim();
            const n2 = appState.mode===2 ? document.getElementById('name2').value.trim() : "-";
            if(!n1 || (appState.mode===2 && !n2)) { showToast("‚ö†Ô∏è Isi semua nama!", "#c0392b"); return; }
            appState.players[0].name = n1; appState.players[1].name = n2;
            showScreen('level-screen');
        }

        // --- GAME LOGIC ---
        function startGame(themeIdx) {
            appState.currentThemeIdx = themeIdx;
            appState.questionQueue = vocabData[themeIdx].items; 
            appState.currentWordIdx = 0;
            appState.players.forEach(p => { 
                p.score=0; p.mistakes=0; p.wordIdx = 0; p.lives = 3; p.finished = false;
            });
            appState.timer = parseInt(appState.timeLimit);
            document.getElementById('dispTimer').innerText = appState.timer;
            loadPlayerQuestion(1);
            if(appState.mode===2) { document.getElementById('p2-panel').style.display='flex'; loadPlayerQuestion(2); }
            else { document.getElementById('p2-panel').style.display='none'; }
            showScreen('game-screen');
            startTimer(); 
        }

        function loadPlayerQuestion(pNum) {
            const pIdx = pNum - 1; const player = appState.players[pIdx];
            if (player.wordIdx >= appState.questionQueue.length) {
                player.finished = true;
                document.getElementById(`p${pNum}-overlay`).style.display = 'flex';
                document.getElementById(`p${pNum}-overlay`).innerHTML = `<div>‚úÖ SELESAI</div><div style="font-size:1rem; margin-top:10px;">Menunggu Waktu...</div>`;
                return;
            }
            const raw = appState.questionQueue[player.wordIdx];
            const wordArab = raw[0]; const wordArti = raw[1]; const wordImg = raw[2]; 
            const segments = parseArabicWord(wordArab);
            const structure = segments.map(seg => ({ base: seg[0], harakat: seg.substring(1), full: seg }));
            let pool = structure.map((s, i) => ({ ...s, id: 'c'+i }));
            const distractors = ["ÿ®","ÿ™","ÿ´","ÿ¨","ÿ≠","ÿÆ","ÿØ","ÿ±","ÿ≥","ÿµ","ÿ∑","ÿπ","ŸÅ","ŸÇ","ŸÉ","ŸÑ","ŸÖ","ŸÜ","Ÿá","Ÿà","Ÿä"];
            for(let i=0; i<3; i++) {
                const randChar = distractors[Math.floor(Math.random() * distractors.length)];
                pool.push({ base: randChar, harakat: "Ÿé", full: randChar+"Ÿé", id: 'd'+i });
            }
            pool.sort(() => Math.random() - 0.5);
            player.currentWord = { word: wordArab, meaning: wordArti, image: wordImg, structure: structure, pool: pool };
            document.getElementById(`p${pNum}-round-disp`).innerText = `Soal ${player.wordIdx + 1}/${appState.questionQueue.length}`;
            renderPlayerBoard(pNum, player.currentWord);
        }

        function renderPlayerBoard(pNum, lvl) {
            document.getElementById(`p${pNum}-overlay`).style.display = 'none';
            document.getElementById(`p${pNum}-name-disp`).innerText = appState.players[pNum-1].name;
            document.getElementById(`p${pNum}-lives`).innerText = "‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è";
            document.getElementById(`p${pNum}-score-disp`).innerText = appState.players[pNum-1].score;
            document.getElementById(`p${pNum}-msg`).innerText = "";
            const imgEl = document.getElementById(`p${pNum}-img`);
            imgEl.src = lvl.image; imgEl.onerror = function() { this.src = placeholderImg; }; 
            document.getElementById(`p${pNum}-check`).style.display = 'none';
            document.getElementById(`p${pNum}-meaning`).innerText = lvl.meaning;
            
            const hintEl = document.getElementById(`p${pNum}-hint`);
            // LOGIKA HINT: HANYA MUNCUL DI LEVEL 90 DETIK (LAMBAT)
            if (parseInt(appState.timeLimit) === 90) { 
                hintEl.innerText = lvl.word; 
                hintEl.style.display = 'block'; 
            } else { 
                hintEl.innerText = ""; 
                hintEl.style.display = 'none'; 
            }
            
            const sArea = document.getElementById(`p${pNum}-slots`); sArea.innerHTML = '';
            lvl.structure.forEach(() => { const s = document.createElement('div'); s.className = 'slot'; s.onclick = removeLetter; sArea.appendChild(s); });
            const pArea = document.getElementById(`p${pNum}-pool`); pArea.innerHTML = '';
            const myPool = JSON.parse(JSON.stringify(lvl.pool)).sort(()=>Math.random()-0.5);
            myPool.forEach(item => {
                const d = document.createElement('div'); d.className = 'letter-card';
                d.textContent = item.full; d.id = `p${pNum}-${item.id}`;
                d.dataset.full = item.full; d.dataset.base = item.base; d.dataset.harakat = item.harakat;
                initTouchDrag(d); d.draggable = true;
                d.ondragstart = (e) => { e.dataTransfer.setData("text", d.id); };
                pArea.appendChild(d);
            });
            sArea.querySelectorAll('.slot').forEach(s => {
                s.ondragover = e => e.preventDefault();
                s.ondrop = (e) => { e.preventDefault(); if(s.children.length>0) return; const id=e.dataTransfer.getData("text"); if(id.startsWith(`p${pNum}`)) placeLetter(document.getElementById(id), s); };
            });
        }

        const letterForms = { 'ŸÉ':{isolated:'ŸÉ',initial:'Ôªõ',medial:'Ôªú',final:'Ôªö'}, 'ÿ™':{isolated:'ÿ™',initial:'Ô∫ó',medial:'Ô∫ò',final:'Ô∫ñ'}, 'ÿß':{isolated:'ÿß',initial:'ÿß',medial:'Ô∫é',final:'Ô∫é'}, 'ÿ®':{isolated:'ÿ®',initial:'Ô∫ë',medial:'Ô∫í',final:'Ô∫ê'}, 'ŸÜ':{isolated:'ŸÜ',initial:'Ôªß',medial:'Ôª®',final:'Ôª¶'}, 'Ÿä':{isolated:'Ÿä',initial:'Ôª≥',medial:'Ôª¥',final:'Ôª≤'}, 'ÿπ':{isolated:'ÿπ',initial:'Ôªã',medial:'Ôªå',final:'Ôªä'}, 'ÿ∫':{isolated:'ÿ∫',initial:'Ôªè',medial:'Ôªê',final:'Ôªé'}, 'ŸÇ':{isolated:'ŸÇ',initial:'Ôªó',medial:'Ôªò',final:'Ôªñ'}, 'ŸÑ':{isolated:'ŸÑ',initial:'Ôªü',medial:'Ôª†',final:'Ôªû'}, 'ŸÖ':{isolated:'ŸÖ',initial:'Ôª£',medial:'Ôª§',final:'Ôª¢'}, 'ÿ≥':{isolated:'ÿ≥',initial:'Ô∫≥',medial:'Ô∫¥',final:'Ô∫≤'}, 'ÿ¥':{isolated:'ÿ¥',initial:'Ô∫∑',medial:'Ô∫∏',final:'Ô∫∂'}, 'ÿµ':{isolated:'ÿµ',initial:'Ô∫ª',medial:'Ô∫º',final:'Ô∫∫'}, 'ÿ∂':{isolated:'ÿ∂',initial:'Ô∫ø',medial:'ÔªÄ',final:'Ô∫æ'}, 'ÿ∑':{isolated:'ÿ∑',initial:'ÔªÉ',medial:'ÔªÑ',final:'ÔªÇ'}, 'ÿ∏':{isolated:'ÿ∏',initial:'Ôªá',medial:'Ôªà',final:'ÔªÜ'}, 'Ÿá':{isolated:'Ÿá',initial:'Ôª´',medial:'Ôª¨',final:'Ôª™'}, 'ÿ¨':{isolated:'ÿ¨',initial:'Ô∫ü',medial:'Ô∫†',final:'Ô∫û'}, 'ÿ≠':{isolated:'ÿ≠',initial:'Ô∫£',medial:'Ô∫§',final:'Ô∫¢'}, 'ÿÆ':{isolated:'ÿÆ',initial:'Ô∫ß',medial:'Ô∫®',final:'Ô∫¶'}, 'ÿ´':{isolated:'ÿ´',initial:'Ô∫õ',medial:'Ô∫ú',final:'Ô∫ö'}, 'ŸÅ':{isolated:'ŸÅ',initial:'Ôªì',medial:'Ôªî',final:'Ôªí'} };
        const nonConnectors = ['ÿß','ÿØ','ÿ∞','ÿ±','ÿ≤','Ÿà','ÿ§','ÿ¢','ÿ£','ÿ•'];

        function updateForms(pNum) {
            const slots = document.getElementById(`p${pNum}-slots`).children;
            Array.from(slots).forEach((slot, i) => {
                if(slot.children.length===0) return;
                const card = slot.children[0]; const base = card.dataset.base;
                const hasRight = (i>0 && slots[i-1].children.length>0); const hasLeft = (i<slots.length-1 && slots[i+1].children.length>0);
                let isRightNonConn = false;
                if(hasRight) { const rightBase = slots[i-1].children[0].dataset.base; if(nonConnectors.includes(rightBase)) isRightNonConn = true; }
                let form = 'isolated';
                if(!hasRight && hasLeft) form='initial'; else if(hasRight && hasLeft && !isRightNonConn) form='medial'; else if(hasRight && !hasLeft && !isRightNonConn) form='final'; else if(hasRight && isRightNonConn) form=hasLeft?'initial':'isolated';
                if(letterForms[base] && letterForms[base][form]) card.textContent = letterForms[base][form] + card.dataset.harakat; else card.textContent = card.dataset.full;
            });
        }

        // --- INTERACTION ---
        function initTouchDrag(el) {
            el.addEventListener('touchstart', (e) => { 
                e.preventDefault(); const touch = e.changedTouches[0];
                activeDrags[touch.identifier] = { el: el, startX: touch.clientX, startY: touch.clientY, startTime: Date.now(), origL: el.style.left, origT: el.style.top };
                el.classList.add('touch-dragging'); moveElement(el, touch.clientX, touch.clientY); playSound('pop');
            }, {passive:false});
            el.addEventListener('touchmove', (e) => { 
                e.preventDefault(); for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i]; if (activeDrags[touch.identifier]) moveElement(activeDrags[touch.identifier].el, touch.clientX, touch.clientY);
                }
            }, {passive:false});
            el.addEventListener('touchend', (e) => { 
                e.preventDefault(); for (let i = 0; i < e.changedTouches.length; i++) {
                    const touch = e.changedTouches[i]; const data = activeDrags[touch.identifier];
                    if (data) { handleDrop(data.el, touch.clientX, touch.clientY); delete activeDrags[touch.identifier]; }
                }
            });
        }
        function moveElement(el, x, y) { el.style.left=(x-25)+'px'; el.style.top=(y-50)+'px'; }
        function handleDrop(el, x, y) {
            el.classList.remove('touch-dragging'); el.style.display='none';
            let target = document.elementFromPoint(x, y); el.style.display='';
            if(target && target.closest('.slot')) {
                const slot = target.closest('.slot');
                if(slot.children.length===0) {
                    const elP = el.id.startsWith('p1') ? 1 : 2; const slotP = slot.parentElement.id.includes('p1') ? 1 : 2;
                    if(elP === slotP) { placeLetter(el, slot); return; }
                }
            }
            el.style.position=''; el.style.left=''; el.style.top='';
        }
        function placeLetter(el, slot) {
            const pNum = slot.parentElement.id.includes('p1') ? 1 : 2;
            const clone = el.cloneNode(true); clone.id = ""; clone.dataset.oid = el.id; 
            clone.classList.remove('touch-dragging'); clone.style.position=''; clone.onclick = (e) => { e.stopPropagation(); restoreLetter(clone, slot, pNum); };
            slot.appendChild(clone); el.classList.add('hidden'); updateForms(pNum); checkCompletion(pNum);
        }
        function removeLetter(e) {
            const slot = e.target.closest('.slot'); if(slot.children.length===0) return;
            const pNum = slot.parentElement.id.includes('p1') ? 1 : 2; restoreLetter(slot.children[0], slot, pNum);
        }
        function restoreLetter(child, slot, pNum) {
            document.getElementById(child.dataset.oid).classList.remove('hidden');
            slot.removeChild(child); slot.classList.remove('wrong','correct');
            updateForms(pNum); document.getElementById(`p${pNum}-check`).style.display='none';
        }
        function checkCompletion(pNum) { if(document.getElementById(`p${pNum}-slots`).querySelectorAll('.slot:empty').length===0) document.getElementById(`p${pNum}-check`).style.display='inline-block'; }

        function handleCheck(e, pNum) { e.preventDefault(); playSound('pop'); checkAnswer(pNum); }
        function checkAnswer(pNum) {
            const pIdx = pNum - 1; const lvl = appState.players[pIdx].currentWord; const slots = document.getElementById(`p${pNum}-slots`).children; let correct = true;
            Array.from(slots).forEach((s, i) => {
                if(s.children.length===0) { correct=false; return; }
                if(s.children[0].dataset.full === lvl.structure[i].full) { s.classList.add('correct'); s.classList.remove('wrong'); }
                else { s.classList.add('wrong'); s.classList.remove('correct'); correct=false; }
            });

            if(correct) {
                const bonus = 10; appState.players[pIdx].score += bonus; 
                document.getElementById(`p${pNum}-score-disp`).innerText = appState.players[pIdx].score;
                document.getElementById(`p${pNum}-msg`).innerText = "MUMTAZ! üéâ";
                document.getElementById(`p${pNum}-msg`).style.color = "var(--primary)";
                document.getElementById(`p${pNum}-check`).style.display = 'none';
                document.getElementById(`p${pNum}-hint`).style.display = 'block'; 
                playSound('win'); confetti(); playTTS(pNum);
                setTimeout(() => { appState.players[pIdx].wordIdx++; loadPlayerQuestion(pNum); }, 1500);
            } else {
                appState.players[pIdx].lives--; appState.players[pIdx].mistakes++;
                document.getElementById(`p${pNum}-lives`).innerText = "‚ù§Ô∏è".repeat(appState.players[pIdx].lives) + "üñ§".repeat(3-appState.players[pIdx].lives);
                playSound('lose');
                if(appState.players[pIdx].lives <= 0) {
                    document.getElementById(`p${pNum}-msg`).innerText = "Game Over"; document.getElementById(`p${pNum}-msg`).style.color = "var(--wrong)";
                    appState.players[pIdx].finished = true; document.getElementById(`p${pNum}-check`).style.display = 'none';
                    document.getElementById(`p${pNum}-overlay`).innerHTML = `<div>‚ùå GAME OVER</div><div style="font-size:1rem;">Menunggu Waktu...</div>`;
                    document.getElementById(`p${pNum}-overlay`).style.display = 'flex';
                }
            }
        }

        function startTimer() {
            if(appState.interval) clearInterval(appState.interval);
            appState.interval = setInterval(() => {
                appState.timer--; document.getElementById('dispTimer').innerText = appState.timer;
                if(appState.timer <= 0) { stopTimer(); showResult(); }
            }, 1000);
        }
        function stopTimer() { clearInterval(appState.interval); }

        function showResult() {
            stopTimer();
            document.getElementById('result-overlay').style.display='flex';
            const content = document.getElementById('resultContent');
            let html = `<div><h1 style="color:var(--primary); font-family:'Amiri'; margin:0;">Waktu Habis!</h1></div><hr>`;
            
            // Generate current Theme Name
            const currentThemeName = vocabData[appState.currentThemeIdx].theme;

            if(appState.mode === 1) {
                const p1 = appState.players[0];
                addToLeaderboard(p1.name, p1.score, currentThemeName);
                html += `<div>Skor Akhir: <b style="font-size:2rem">${appState.players[0].score}</b></div><div style="font-size:0.9rem">Salah: ${appState.players[0].mistakes}</div>`;
            } else {
                const p1 = appState.players[0]; 
                const p2 = appState.players[1];
                addToLeaderboard(p1.name, p1.score, currentThemeName);
                addToLeaderboard(p2.name, p2.score, currentThemeName);
                
                let winner = "Seri!"; let wColor = "#555";
                if(p1.score > p2.score) { winner = p1.name + " Menang!"; wColor= "var(--primary)"; }
                else if(p2.score > p1.score) { winner = p2.name + " Menang!"; wColor= "var(--accent)"; }
                html += `<div style="display:flex; justify-content:space-around; align-items:center; margin-top:20px;"><div><h3>${p1.name}</h3><h1 style="color:var(--primary)">${p1.score}</h1><small>Salah: ${p1.mistakes}</small></div><div style="font-size:1.5rem; color:#ccc;">VS</div><div><h3>${p2.name}</h3><h1 style="color:var(--accent)">${p2.score}</h1><small>Salah: ${p2.mistakes}</small></div></div><h1 style="color:${wColor}; margin-top:20px; font-family:'Changa One'">${winner}</h1>`;
            }
            content.innerHTML = html;
            sendToGoogleSheet();
        }

        // --- PERSISTENT LEADERBOARD ---
        function loadScores() {
            const stored = localStorage.getItem('jawaraScores');
            if(stored) localHighScores = JSON.parse(stored);
        }
        function saveScores() {
            localStorage.setItem('jawaraScores', JSON.stringify(localHighScores));
        }
        function addToLeaderboard(name, score, theme) {
            localHighScores.push({name, score, theme});
            localHighScores.sort((a, b) => b.score - a.score);
            localHighScores = localHighScores.slice(0, 3); 
            saveScores();
        }
        
        function openLeaderboard(){
            loadScores(); 
            const list = document.getElementById('lb-list'); const msg = document.getElementById('lb-empty-msg'); list.innerHTML = "";
            if(localHighScores.length === 0) { msg.style.display = "block"; } else { 
                msg.style.display = "none"; 
                localHighScores.forEach((item, idx) => { 
                    const li = document.createElement('li'); 
                    li.className = 'lb-item'; 
                    li.innerHTML = `
                        <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                            <div style="text-align:left;">
                                <span>${idx+1}. ${item.name}</span>
                                <div style="font-size:0.8rem; color:#888;">${item.theme || 'Umum'}</div>
                            </div>
                            <span style="font-weight:bold;">${item.score}</span>
                        </div>
                    `; 
                    list.appendChild(li); 
                }); 
            }
            document.getElementById('leaderboard-modal').style.display='flex';
        }

        function sendToGoogleSheet() { if(!GOOGLE_SCRIPT_URL) return; const playersToSend = []; playersToSend.push(appState.players[0]); if(appState.mode === 2) playersToSend.push(appState.players[1]); playersToSend.forEach(p => { if(!p.name) return; const data = { date: new Date().toLocaleString(), name: p.name, score: p.score, mistakes: p.mistakes, mode: appState.mode === 1 ? "1 Player" : "2 Player", level: "Sesi " + (appState.currentThemeIdx + 1) }; fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(() => console.log("Sent")).catch(e => console.error(e)); }); }
        function backToLevels() { document.getElementById('result-overlay').style.display='none'; showScreen('level-screen'); }
        function confirmExit() { showScreen('entry-screen'); }
        function showToast(t,c) { const x=document.getElementById('toast'); x.innerText=t; x.style.background=c; x.className="show"; setTimeout(()=>{x.className=x.className.replace("show","")},3000); }
        function openSettings(){document.getElementById('settings-modal').style.display='flex'}
        function closeSettings(){ const d=document.getElementsByName('time'); for(let r of d) if(r.checked) appState.timeLimit=r.value; const s=document.getElementsByName('sound'); for(let r of s) if(r.checked) appState.sound=r.value; document.getElementById('settings-modal').style.display='none'; showToast("Pengaturan Disimpan!"); }
        function closeLeaderboard(){document.getElementById('leaderboard-modal').style.display='none'}
        
        // NEW FUNCTIONS
        function openInstructions() {
            document.getElementById('instruction-modal').style.display = 'flex';
        }
        function closeInstructions() {
            document.getElementById('instruction-modal').style.display = 'none';
        }

        function playTTS(pNum) { 
            if(appState.sound === 'off') return;
            const pIdx = pNum; 
            if(appState.players[pIdx] && appState.players[pIdx].currentWord) {
                const u=new SpeechSynthesisUtterance(appState.players[pIdx].currentWord.word); 
                u.lang='ar-SA'; u.rate=0.8; window.speechSynthesis.speak(u); 
            }
        }
    </script>
</body>
</html>
